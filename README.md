# BingxClient

Простой Python-клиент для работы с открытым API биржи BingX (swap).
Реализует минимальный набор функционала: получение времени сервера, рыночной (mark) цены, данных по позициям и выставление рыночных ордеров с опциональными стоп-лосс / тейк-профит параметрами.

> ⚠️ Важно: этот клиент — лёгкая обёртка для личного использования / демонстрации и **не** является официальной библиотекой. Используйте осторожно: проверьте запросы и сигнатуры прежде чем использовать в реальной торговле.

---

## Особенности

* Поддержка подписи запросов HMAC-SHA256.
* Автоматическая корректировка временного сдвига (server time offset).
* Удобный метод размещения рыночного ордера с опциями стоп-лосса и тейк-профита.
* Небольшая зависимость: `requests`.

---

## Установка

1. Склонируйте репозиторий или добавьте файл `bingxclient.py` в проект.
2. Установите зависимость:

```bash
pip install requests
```

---

## Быстрый пример использования

```python
from bingxclient import BingxClient

API_KEY = "ваш_api_key"
API_SECRET = "ваш_api_secret"

client = BingxClient(API_KEY, API_SECRET, symbol="BTCUSDT")

# Получить mark price
mark = client.get_mark_price()
print("Mark price:", mark)

# Получить текущие позиции по символу
positions = client.get_positions()
print("Positions:", positions)

# Отправить рыночный ордер на лонг (buy) на 0.001 контракта
resp = client.place_market_order(side="long", qty=0.001)
print("Order response:", resp)

# Отправить ордер с стоп-лоссом и тейк-профитом
resp2 = client.place_market_order(side="short", qty=0.001, stop=41000, tp=39000)
print("Order with SL/TP:", resp2)
```

---

## API-референс (функции и объяснения)

Ниже — краткое объяснение каждой важной функции в `bingxclient.py`.

### `BingxClient(api_key: str, api_secret: str, symbol: str = None)`

Конструктор. Параметры:

* `api_key` — ваш публичный ключ API.
* `api_secret` — секретный ключ для подписи запросов.
* `symbol` — опциональный символ в формате `BTCUSDT`. Клиент конвертирует его в формат BingX (например `BTC-USDT`) внутри.

При инициализации вычисляет смещение времени между локальным временем и временем сервера (через `get_server_time_offset`) — это важно для корректной подписи запросов, зависящих от `timestamp`.

---

### `_to_bingx_symbol(symbol: str) -> str`

Вспомогательный метод, который приводит привычный формат `BTCUSDT` к формату BingX `BTC-USDT` (если это ещё не сделано).

---

### `_sign(query: str) -> str`

Создаёт HMAC-SHA256 подпись от строки `query` с использованием `api_secret`. Возвращает hex-строку подписи.

---

### `_request(method: str, path: str, params=None)`

Универсальный метод для авторизованных запросов:

* Собирает параметры, сортирует ключи, формирует query string.
* Подписывает query строку (`signature`) и добавляет в URL.
* Отправляет запрос с заголовком `X-BX-APIKEY`.
* Бросает исключение при ошибке HTTP (`r.raise_for_status()`) и возвращает результат в формате JSON.

> Замечание: текущая реализация формирует URL как `...{path}?{query}&signature={signature}` — убедитесь, что API BingX ожидает такой формат и проставляет `timestamp`/`recvWindow`/другие обязательные параметры в `params`.

---

### `_public_request(path: str, params=None, timeout: int = 10)`

Универсальный метод для публичных GET-запросов (без подписи). Возвращает JSON-ответ.

---

### `get_server_time_offset()`

Запрашивает `/openApi/swap/v2/server/time` и вычисляет разницу между `serverTime` и локальным `time.time()*1000`. Возвращает смещение в миллисекундах. Если запрос неуспешен — возвращает `0`.

---

### `get_mark_price(symbol=None)`

Запрашивает `premiumIndex` (маркет прайс) через публичный эндпоинт `/openApi/swap/v2/quote/premiumIndex`.
Возвращает float mark price или `None` при ошибке / отсутствии данных. Учитывает форму `data` в ответе (список или словарь).

---

### `get_positions(symbol=None)`

Авторизованный GET-запрос к `/openApi/swap/v2/user/positions` с параметром `symbol`. Возвращает `data` из ответа (по умолчанию пустой список при отсутствии).

---

### `place_market_order(side: str, qty: float, symbol: str = None, stop: float = None, tp: float = None)`

Размещает рыночный ордер (POST `/openApi/swap/v2/trade/order`). Параметры:

* `side`: `"long"` или `"short"`. Внутри преобразуется: `"long"` → `BUY` и `positionSide` = `LONG`; `"short"` → `SELL` / `SHORT`.
* `qty`: количество (объём) — как это трактует биржа (контракты / лоты).
* `symbol`: переопределяет символ, по умолчанию используется переданный в `__init__`.
* `stop`: опционально — цена стоп-лосса. Если указана, код собирает JSON-параметр `stopLoss` с типом `STOP_MARKET` и рабочим типом `MARK_PRICE`.
* `tp`: опционально — тейк-профит; формируется параметр `takeProfit` аналогичной структуры.
* В параметры также добавляются `timestamp` (учитывая `time_offset`), `recvWindow` и `timeInForce`.

Возвращает JSON-ответ от API (как словарь). При ошибке `_request` выбросит исключение (HTTP error).

---

## Обработка ошибок и нюансы

* `requests` может поднять исключения (таймауты, сетевые ошибки). В реальном проекте оборачивайте вызовы в `try/except` и логируйте ошибки.
* Убедитесь, что ваш `api_secret` не попадает в лог и не коммитится в репозиторий.
* Проверьте используемый формат `symbol` у BingX — API различных бирж используют разные форматы (`BTCUSDT` vs `BTC-USDT`).
* `place_market_order` формирует стоп/тейк как JSON-строки в параметрах — убедитесь, что это корректно для их API (иногда API ожидает вложенные поля, а не JSON в качестве строкового параметра).
* Валидация входных данных (положительность `qty`, допустимые границы цен) не реализована — добавьте по необходимости.

---

## Безопасность

* Никогда не храните `api_secret` в коде/репозитории. Используйте переменные окружения или секреты CI/CD.
* Ограничьте права API-ключа (если возможно) — не давайте ключу прав на вывод средств.
* Тщательно тестируйте на демо/тестнете перед использованием с реальными средствами.

---


